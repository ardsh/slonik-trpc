"use strict";(self.webpackChunkslonik_trpc_docs=self.webpackChunkslonik_trpc_docs||[]).push([[687],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>g});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=r.createContext({}),u=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=u(e.components);return r.createElement(o.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(n),m=a,g=c["".concat(o,".").concat(m)]||c[m]||d[m]||i;return n?r.createElement(g,l(l({ref:t},p),{},{components:n})):r.createElement(g,l({ref:t},p))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,l=new Array(i);l[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[c]="string"==typeof e?e:a,l[1]=s;for(var u=2;u<i;u++)l[u]=n[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6870:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const i={sidebar_position:7},l="Filtering",s={unversionedId:"tutorial-getting-started/filtering",id:"tutorial-getting-started/filtering",title:"Filtering",description:"Filtering in slonik-trpc allows you to specify which data you want to receive from the database. Once you declare the filters, complex combinations using AND, OR and NOT will be available automatically.",source:"@site/docs/tutorial-getting-started/filtering.md",sourceDirName:"tutorial-getting-started",slug:"/tutorial-getting-started/filtering",permalink:"/docs/tutorial-getting-started/filtering",draft:!1,editUrl:"https://github.com/ardsh/slonik-trpc/tree/main/docs/docs/tutorial-getting-started/filtering.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Usage with tRPC",permalink:"/docs/tutorial-getting-started/trpc"},next:{title:"Authorization",permalink:"/docs/tutorial-getting-started/authorization"}},o={},u=[{value:"Simple filter",id:"simple-filter",level:3},{value:"Filtering with arrays of id",id:"filtering-with-arrays-of-id",level:3},{value:"Using the booleanFilter utility",id:"using-the-booleanfilter-utility",level:3},{value:"Merging filters",id:"merging-filters",level:3},{value:"Usage with tRPC",id:"usage-with-trpc",level:2}],p={toc:u};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"filtering"},"Filtering"),(0,a.kt)("p",null,"Filtering in slonik-trpc allows you to specify which data you want to receive from the database. Once you declare the filters, complex combinations using AND, OR and NOT will be available automatically."),(0,a.kt)("h3",{id:"simple-filter"},"Simple filter"),(0,a.kt)("p",null,"Here is an example of how to build a simple filter:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"createFilter<Context>()({\n    id: z.string(),\n}, {\n    id: (value) => sql.fragment`users.id = ${value}`\n});\n")),(0,a.kt)("p",null,"This filter will accept a string as an ",(0,a.kt)("inlineCode",{parentName:"p"},"id"),", and add a condition to the main query.\nSo passing the following ",(0,a.kt)("inlineCode",{parentName:"p"},"where")," object:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"where: {\n    id: 5\n}\n")),(0,a.kt)("p",null,"Will result in a condition like"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"WHERE users.id = 5\n")),(0,a.kt)("p",null,"Since we're using zod, it's not possible to pass anything but a string in that filter."),(0,a.kt)("p",null,"Suppose we want to query multiple users though. The API builder automatically adds ",(0,a.kt)("inlineCode",{parentName:"p"},"AND"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"OR")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"NOT")," clauses, so this is possible"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"where: {\n    OR: [{\n        id: 5,\n    }, {\n        id: 6\n    }]\n}\n")),(0,a.kt)("p",null,"In SQL it will correspond to this condition (though you don't have to worry about that)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"WHERE ((users.id = 5) OR (users.id = 6))\n")),(0,a.kt)("h3",{id:"filtering-with-arrays-of-id"},"Filtering with arrays of id"),(0,a.kt)("p",null,"To make it easier to query multiple IDs at once, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"arrayFilter")," utility function. Here is an example of how to use it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"createFilter<Context>()({\n    ids: z.array(z.string()),\n}, {\n    ids: (values) => sql.fragment`users.id = ANY(${sql.array(values, 'text')})`\n});\n")),(0,a.kt)("p",null,"Using the ",(0,a.kt)("inlineCode",{parentName:"p"},"arrayFilter")," utility for this kind of filter makes it easier to declare. For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"createFilter<Context>()({\n    ids: arrayStringFilterType,\n}, {\n    ids: (values) => arrayFilter(values, sql.fragment`users.id`)\n});\n")),(0,a.kt)("p",null,"Then, to use the filter, you can pass an ",(0,a.kt)("inlineCode",{parentName:"p"},"ids")," array to the ",(0,a.kt)("inlineCode",{parentName:"p"},"where")," object:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"where: {\n    ids: [3, 4, 5]\n}\n")),(0,a.kt)("p",null,"This will produce an SQL condition like the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"WHERE users.id = ANY([3,4,5]::text[])\n")),(0,a.kt)("h3",{id:"using-the-booleanfilter-utility"},"Using the booleanFilter utility"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"booleanFilter")," utility takes in a fragment and applies it if the input is true. It applies the reverse if the input is ",(0,a.kt)("inlineCode",{parentName:"p"},"false"),", and doesn't apply anything if the input is ",(0,a.kt)("inlineCode",{parentName:"p"},"null"),"/",(0,a.kt)("inlineCode",{parentName:"p"},"undefined"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const filters = createFilters()({\n    isGmail: z.boolean(),\n}, {\n    isGmail: (value) => booleanFilter(value, `users.email ILIKE '%gmail.com'`),\n});\n")),(0,a.kt)("p",null,"To use the filter, you can pass an ",(0,a.kt)("inlineCode",{parentName:"p"},"isGmail")," value to the ",(0,a.kt)("inlineCode",{parentName:"p"},"where")," object:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const nonGmailUsers = await filtersLoader.load({\n    where: {\n        isGmail: false,\n    }\n});\n")),(0,a.kt)("p",null,"This will return only users that have their email ending in gmail.com."),(0,a.kt)("p",null,"The equivalent SQL would be"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"WHERE NOT(email ILIKE '%gmail.com')\n")),(0,a.kt)("h3",{id:"merging-filters"},"Merging filters"),(0,a.kt)("p",null,"A good method of organization might be to declare filters based on the tables they access, e.g. ",(0,a.kt)("inlineCode",{parentName:"p"},"users")," filters, ",(0,a.kt)("inlineCode",{parentName:"p"},"posts")," filters, etc., then merge them at the end."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const userFilters = createFilters()({\n    isGmail: z.boolean(),\n    userIds: arrayStringFilterType,\n}, {\n    userIds: (values) => arrayFilter(values, sql.fragment`users.id`),\n    isGmail: (value) => booleanFilter(value, `users.email ILIKE '%gmail.com'`),\n});\n\nconst postFilters = createFilters()({\n    postIds: arrayStringFilterType,\n    longPost: z.boolean(),\n}, {\n    postIds: (values) => arrayFilter(values, sql.fragment`posts.id`),\n    longPost: (value) => booleanFilter(value, sql.fragment`LENGTH(posts.content) > 500`),\n});\n\n// merge filters\nconst filters = mergeFilters([userFilters, postFilters]);\n")),(0,a.kt)("p",null,"Now, the filters object has all the filters that are declared in the userFilters and postFilters objects. You can use the filters object in the makeQueryLoader function:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { mergeFilters } from 'slonik-trpc/utils';\n\nconst postsLoader = makeQueryLoader({\n    db,\n    query: sql.type(zodType)`SELECT posts.*, users.first_name, users.last_name FROM posts LEFT JOIN users ON users.id = posts.author_id`,\n    filters,\n})\n")),(0,a.kt)("p",null,"To use the filters, pass the where object to the load() function:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const posts = await postsLoader.load({\n  where: {\n    OR: [{\n      userIds: [1, 2, 3],\n    }, {\n      longPost: true,\n    }]\n  }\n});\n")),(0,a.kt)("p",null,"This will produce an SQL query like the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT *\nFROM posts\nLEFT JOIN users ON users.id = posts.user_id\nWHERE (users.id = ANY([1,2,3]::text[]) OR LENGTH(posts.content) > 500)\n")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"The mergeFilters function helps with type safety, just like createFilters. They're not necessary if you specify the filters directly as options in the makeQueryLoader options, but that doesn't allow easy reusability.")),(0,a.kt)("h2",{id:"usage-with-trpc"},"Usage with tRPC"),(0,a.kt)("p",null,"It is recommended to disable OR filters, because they can be computationally expensive.\nWhen calling the getLoadArgs function, specify the disabled filters:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"getPosts: publicProcedure\n    .input(postsLoader.getLoadArgs({\n        disabledFilters: {\n            OR: true,\n        }\n    }))\n    .query(({ input, ctx }) => {\n        return postsLoader.loadPagination({\n            ...input,\n            ctx,\n        });\n    }),\n")))}c.isMDXComponent=!0}}]);