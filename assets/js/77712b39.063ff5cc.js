"use strict";(self.webpackChunkslonik_trpc_docs=self.webpackChunkslonik_trpc_docs||[]).push([[316],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=l(n),d=r,h=c["".concat(p,".").concat(d)]||c[d]||g[d]||s;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,o=new Array(s);o[0]=d;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[c]="string"==typeof e?e:r,o[1]=i;for(var l=2;l<s;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5842:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var a=n(7462),r=(n(7294),n(3905));const s={sidebar_position:9},o="Cursor Pagination",i={unversionedId:"client-type-safety/cursor-pagination",id:"client-type-safety/cursor-pagination",title:"Cursor Pagination",description:"You can read about cursor pagination and its benefits in this article from slack.",source:"@site/docs/client-type-safety/cursor-pagination.md",sourceDirName:"client-type-safety",slug:"/client-type-safety/cursor-pagination",permalink:"/slonik-trpc/docs/client-type-safety/cursor-pagination",draft:!1,editUrl:"https://github.com/ardsh/slonik-trpc/tree/main/docs/docs/client-type-safety/cursor-pagination.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9},sidebar:"tutorialSidebar",previous:{title:"Declaring table columns dependencies type-safely",permalink:"/slonik-trpc/docs/client-type-safety/table-selection"},next:{title:"Extra Utilities",permalink:"/slonik-trpc/docs/category/extra-utilities"}},p={},l=[{value:"Saving the pagination state",id:"saving-the-pagination-state",level:3},{value:"Navigating from within the reducer",id:"navigating-from-within-the-reducer",level:4},{value:"Pagination Component",id:"pagination-component",level:2},{value:"Pagination Props",id:"pagination-props",level:3},{value:"usePaginationProps",id:"usepaginationprops",level:3},{value:"Usage in query",id:"usage-in-query",level:3},{value:"Switching sorting columns",id:"switching-sorting-columns",level:3},{value:"Complete Implementation",id:"complete-implementation",level:2},{value:"The reducer implementation",id:"the-reducer-implementation",level:3}],u={toc:l};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"cursor-pagination"},"Cursor Pagination"),(0,r.kt)("p",null,"You can read about cursor pagination and its benefits ",(0,r.kt)("a",{parentName:"p",href:"https://slack.engineering/evolving-api-pagination-at-slack/"},"in this article from slack"),"."),(0,r.kt)("p",null,"In this tutorial I want to demonstrate how to load data in a table using cursor pagination."),(0,r.kt)("p",null,"Normally we use offset-based pagination for loading tabular data, but it is possible to simulate a very similar experience (navigating through pages bidirectionally) using cursor-based pagination, or a mix of cursor+offset based pagination, since ",(0,r.kt)("inlineCode",{parentName:"p"},"slonik-trpc")," offers both.",(0,r.kt)("br",{parentName:"p"}),"\n",'By a mix, I mean using offset-based pagination to "jump" forward or backwards more than one page at a time.'),(0,r.kt)("p",null,"The main use-cases:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Load a page of employees in a table of employees."),(0,r.kt)("li",{parentName:"ul"},"Navigate to the next page, or the previous page (two-way cursor pagination)."),(0,r.kt)("li",{parentName:"ul"},"Jump to the last page, or the first page."),(0,r.kt)("li",{parentName:"ul"},"Jump two pages forwards, or two pages backwards.")),(0,r.kt)("h3",{id:"saving-the-pagination-state"},"Saving the pagination state"),(0,r.kt)("p",null,"We start by defining the pagination state in a reducer."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="useCursorPagination.ts"',title:'"useCursorPagination.ts"'},"type CursorPagination = {\n    /** The current page cursor. If empty, we're in the first page.\n     * Whenever we change the page, this changes.\n     * */\n    currentCursor?: string,\n    /** How many items are being skipped. Used for skipping pages when navigating */\n    skip?: number,\n    /** A counter that keeps track of the current page.\n     * Useful if we want to show a page number in the UI */\n    currentPage?: number | null,\n    /** The first cursor of the current page, as specified by the data source*/\n    startCursor?: string,\n    /** The end cursor of the current page, as specified by the data source */\n    endCursor?: string,\n    /** Whether the data source has a next page */\n    hasNextPage?: boolean,\n    /** Whether the data source has a previous page */\n    hasPreviousPage?: boolean,\n    /** Whether we're paging backwards (used when going to previous/last page) */\n    reverse?: boolean,\n    /** The amount of items to take */\n    pageSize?: number,\n}\n")),(0,r.kt)("p",null,"And we'll use these actions to change the data:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"export type CursorPaginationAction = {\n    type: 'UPDATE_DATA',\n    // Update cursors when data changes\n    data: {\n        startCursor?: string | null,\n        endCursor?: string | null,\n        hasNextPage?: boolean,\n        hasPreviousPage?: boolean,\n    }\n} | {\n    type: 'TABLE_CHANGE',\n    // Change the page size\n    pageSize: number,\n} | {\n    type: 'FIRST_PAGE',\n} | {\n    type: 'LAST_PAGE',\n} | {\n    type: 'NEXT_PAGE',\n    // Optional telling how many pages to skip (normally 0)\n    skipPages?: number,\n} | {\n    type: 'PREVIOUS_PAGE',\n    skipPages?: number,\n}\n")),(0,r.kt)("p",null,"The actual reducer is fairly boilerplate, I'll show it at the end."),(0,r.kt)("h4",{id:"navigating-from-within-the-reducer"},"Navigating from within the reducer"),(0,r.kt)("p",null,"I want the pagination reducer to be fully responsible for navigation."),(0,r.kt)("p",null,"To do this, the reducer has to keep track of the start and end cursors of each page, in the pagination state."),(0,r.kt)("p",null,"For example, when the ",(0,r.kt)("inlineCode",{parentName:"p"},"NEXT_PAGE")," action is dispatched, I want to fetch the next 25 items after the current page."),(0,r.kt)("p",null,"So in that case the reducer should set the currentCursor to the ",(0,r.kt)("inlineCode",{parentName:"p"},"endCursor")," of the current page, and to do that it needs to know what the ",(0,r.kt)("inlineCode",{parentName:"p"},"endCursor")," of the current page is at all times."),(0,r.kt)("p",null,"To keep the reducer state up to date with these cursors, we can create a hook function and call it directly below the ",(0,r.kt)("inlineCode",{parentName:"p"},"useQuery")," hook of ",(0,r.kt)("inlineCode",{parentName:"p"},"tRPC"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const { data, isLoading } = trpc.employees.getEmployees.useQuery(...);\nemployeeLoader.useUpdateQueryData(data);\n")),(0,r.kt)("p",null,"We add this hook to the table data loader function from earlier."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="tableDataLoader.ts"',title:'"tableDataLoader.ts"'},"useUpdateQueryData: (data?: {\n  nodes?: readonly TPayload[] | null,\n  pageInfo?: {\n    hasNextPage?: boolean,\n    hasPreviousPage?: boolean,\n    startCursor?: string | null,\n    endCursor?: string | null,\n  }\n}) => {\n  const dispatch = React.useContext(DispatchContext);\n\n  React.useEffect(() => {\n    if (data) {\n      dispatch({\n        type: 'UPDATE_DATA',\n        data: data?.pageInfo,\n      });\n    }\n  }, [data, dispatch]);\n},\n")),(0,r.kt)("p",null,"Note that I'm calling dispatch on a different reducer than the pagination reducer here."),(0,r.kt)("p",null,"This is because I want the entire table state to be in one place, and to do this I'm adding the pagination state as a sub-object of the main table state."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="tableDataLoader.ts"',title:'"tableDataLoader.ts"'},"import { CursorPaginationAction, CursorPagination, cursorPaginationReducer } from './useCursorPagination';\n\ntype Action = {\n  type: \"APPEND_FIELDS\",\n  dependencies: string[]\n} | CursorPaginationAction;\n\nconst stateReducer = (state: State, action: Action) => {\n  switch (action.type) {\n    case 'APPEND_FIELDS':\n      return {\n        ...state,\n        // Sort alphabetically to have a stable array\n        dependencies: [... new Set(state.dependencies.concat(action.dependencies))].sort(),\n      };\n    default: return {\n      ...state,\n      pagination: cursorPaginationReducer(state.pagination, action),\n    };\n  }\n}\n")),(0,r.kt)("p",null,"Now ",(0,r.kt)("inlineCode",{parentName:"p"},"state.dependencies")," saves the array of dependencies, and ",(0,r.kt)("inlineCode",{parentName:"p"},"state.pagination")," saves the pagination state."),(0,r.kt)("p",null,"These two states can be provided on separate contexts, to prevent unnecessary re-renders."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="tableDataLoader.ts"',title:'"tableDataLoader.ts"'},'export const createTableLoader = <TPayload extends Record<string, any>>() => {\n  const initialState = {\n    dependencies: [],\n    pagination: initialCursorPagination,\n  };\n  const DependenciesContext = React.createContext([] as (keyof TPayload)[]);\n  const PaginationContext = React.createContext(initialCursorPagination);\n  const DispatchContext = React.createContext((() => {\n    throw new Error("tableDataLoader Context provider not found!");\n  }) as React.Dispatch<Action>);\n\n  return {\n    ContextProvider: ({ children }: { children: React.ReactNode }) => {\n      const [state, dispatch] = React.useReducer(stateReducer, initialState);\n      return (<DispatchContext.Provider value={dispatch}>\n        <DependenciesContext.Provider value={state.dependencies}>\n          <PaginationContext.Provider value={state.pagination}>\n            {children}\n          </PaginationContext.Provider>\n        </DependenciesContext.Provider>\n      </DispatchContext.Provider>)\n    },\n    // ...\n')),(0,r.kt)("h2",{id:"pagination-component"},"Pagination Component"),(0,r.kt)("p",null,"We can build a UI component that has 4 buttons (first, previous, next, last) and a page size dropdown."),(0,r.kt)("p",null,"This component would allow going to previous pages, next pages, the first page, or last page. It would also allow the user to change how many items the table should show in a page."),(0,r.kt)("h3",{id:"pagination-props"},"Pagination Props"),(0,r.kt)("p",null,"I want to simply call usePaginationProps and pass its return value down to the CursorPagination component, and not worry about managing the pagination state of specific tables."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="EmployeeList.tsx"',title:'"EmployeeList.tsx"'},"<CursorPagination {...employeeLoader.usePaginationProps()} />\n")),(0,r.kt)("p",null,"This is very useful when we have lots of different tables, and we don't want to write code for handling each one of them."),(0,r.kt)("h3",{id:"usepaginationprops"},"usePaginationProps"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"CursorPagination")," component is dependent on this hook, which means this hook should return functions like ",(0,r.kt)("inlineCode",{parentName:"p"},"onNext"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"onPrevious"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"currentPage"),"."),(0,r.kt)("p",null,"All of these are stored within the cursor pagination state, or are action dispatcher functions (e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"onNext"),"):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="tableDataLoader.ts"',title:'"tableDataLoader.ts"'},"usePaginationProps: () => {\n  const dispatch = React.useContext(DispatchContext);\n  const pagination = React.useContext(PaginationContext);\n\n  return React.useMemo(() => ({\n    onNext: (skipPages=0) => dispatch({ type: 'NEXT_PAGE', skipPages: parseInt(skipPages) }),\n    onPrevious: (skipPages=0) => dispatch({ type: 'PREVIOUS_PAGE', skipPages: parseInt(skipPages) }),\n    onLast: () => dispatch({ type: 'LAST_PAGE' }),\n    onFirst: () => dispatch({ type: 'LAST_PAGE' }),\n    onPageSizeChange: (pageSize: number) => dispatch({ type: 'TABLE_CHANGE', pageSize }),\n    currentPage: pagination.currentPage,\n  }), [dispatch, pagination]);\n},\n")),(0,r.kt)("h3",{id:"usage-in-query"},"Usage in query"),(0,r.kt)("p",null,"We just need to update ",(0,r.kt)("inlineCode",{parentName:"p"},"take"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"cursor")," etc. in the variables of the query"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="tableDataLoader.ts"',title:'"tableDataLoader.ts"'},"useVariables: () => {\n  const dependencies = React.useContext(DependenciesContext);\n\n  const { pageSize = 25, reverse, currentCursor, skip = 0 } = React.useContext(PaginationContext);\n\n  return React.useMemo(() => ({\n    select: dependencies,\n    take: reverse ? -pageSize : pageSize,\n    takeCursors: true,\n    cursor: currentCursor,\n    skip,\n  }), [currentCursor, dependencies, pageSize, reverse, skip]);\n},\n")),(0,r.kt)("p",null,"Usage:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="EmployeeList.tsx"',title:'"EmployeeList.tsx"'},"const pagination = employeeLoader.useVariables();\nconst { data, isLoading } = trpc.employees.getEmployees.useQuery({\n    ...pagination,\n});\nemployeeLoader.useUpdateQueryData(data);\n")),(0,r.kt)("h3",{id:"switching-sorting-columns"},"Switching sorting columns"),(0,r.kt)("p",null,"One thing to be careful here is when sorting data with different columns, the cursor won't be stable.\nSo when we change the sorting columns, we need to reset the cursor as well. Usually that means going to the first page (an empty cursor means we're in the first page)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="EmployeeList.tsx"',title:'"EmployeeList.tsx"'},'import { useSort } from \'@table-library/react-table-library/sort\';\n\n// ...\n\nconst [orderBy, setOrderBy] = React.useState();\n\nconst paginationProps = employeeLoader.usePaginationProps();\nconst pagination = employeeLoader.useVariables();\n\nconst { data, isLoading } = trpc.employees.getEmployees.useQuery({\n    ...pagination,\n    orderBy,\n});\nemployeeLoader.useUpdateQueryData(data);\n\nconst sort = useSort(data, {\n  onChange: (action: any, state: any) => {\n    // Reset to first page when sorting changes\n    paginationProps.onFirstPage();\n    setOrderBy([state.sortKey, state.reverse ? "DESC" : "ASC"]);\n  },\n}, {\n  isServer: true,\n  sortFns: {},\n});\n')),(0,r.kt)("h2",{id:"complete-implementation"},"Complete Implementation"),(0,r.kt)("p",null,"You can see a similar example implementation at ",(0,r.kt)("a",{parentName:"p",href:"https://githubbox.com/ardsh/slonik-trpc/tree/main/examples/datagrid-example"},"slonik-trpc/examples/datagrid-example")),(0,r.kt)("h3",{id:"the-reducer-implementation"},"The reducer implementation"),(0,r.kt)("p",null,"This is the complete implementation of ",(0,r.kt)("inlineCode",{parentName:"p"},"useCursorPagination.ts")," actions and reducer."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="useCursorPagination.ts"',title:'"useCursorPagination.ts"'},"import React from \"react\";\n\nexport const initialCursorPagination: CursorPagination = {\n    hasNextPage: false,\n    currentPage: 1,\n    skip: 0,\n    hasPreviousPage: false,\n    currentCursor: '',\n    startCursor: '',\n    endCursor: '',\n    reverse: false,\n    pageSize: 25,\n}\n\ntype CursorPagination = {\n    /** The current page cursor. If empty, we're in the first page.\n     * Whenever we change the page, this changes.\n     * */\n    currentCursor?: string,\n    /** How many items are being skipped. Used for skipping pages when navigating */\n    skip?: number,\n    /** A counter that keeps track of the current page.\n     * Useful if we want to show a page number in the UI */\n    currentPage?: number | null,\n    /** The first cursor of the current page, as specified by the data source*/\n    startCursor?: string,\n    /** The end cursor of the current page, as specified by the data source */\n    endCursor?: string,\n    /** Whether the data source has a next page */\n    hasNextPage?: boolean,\n    /** Whether the data source has a previous page */\n    hasPreviousPage?: boolean,\n    /** Whether we're paging backwards (used when going to previous/last page) */\n    reverse?: boolean,\n    /** The amount of items to take */\n    pageSize?: number,\n}\n\nexport type CursorPaginationAction = {\n    type: 'UPDATE_DATA',\n    // Update cursors when data changes\n    data: {\n        startCursor?: string | null,\n        endCursor?: string | null,\n        hasNextPage?: boolean,\n        hasPreviousPage?: boolean,\n    }\n} | {\n    type: 'TABLE_CHANGE',\n    // Change the page size\n    pageSize: number,\n} | {\n    type: 'FIRST_PAGE',\n} | {\n    type: 'LAST_PAGE',\n} | {\n    type: 'NEXT_PAGE',\n    // Optional telling how many pages to skip (normally 0)\n    skipPages?: number,\n} | {\n    type: 'PREVIOUS_PAGE',\n    skipPages?: number,\n}\n\nexport function cursorPaginationReducer(state: CursorPagination = initialCursorPagination, action: CursorPaginationAction): CursorPagination {\n    switch (action.type) {\n        case 'TABLE_CHANGE':\n            return {\n                ...state,\n                currentCursor: '', // Go to first page when changing page size\n                skip: 0,\n                currentPage: 1,\n                hasNextPage: true,\n                hasPreviousPage: false,\n                reverse: false,\n                pageSize: action.pageSize,\n            }\n        case 'UPDATE_DATA':\n            return {\n                ...state,\n                // If we skipped pages too much, and reached further than the last page, we should revert back to skip:0)\n                // If there's no startCursor, it must mean we skipped too much.\n                ...(!action.data.startCursor && state.skip && {\n                    skip: 0,\n                    currentPage: state.currentPage !== null ?\n                        Math.max(1, (state.currentPage || 1) - Math.floor(state.skip / (state.pageSize || 25))) : null,\n                }),\n                startCursor: action.data.startCursor || '',\n                endCursor: action.data.endCursor || '',\n                hasNextPage: !!action.data.hasNextPage,\n                hasPreviousPage: !!action.data.hasPreviousPage,\n            }\n        case 'NEXT_PAGE':\n            return {\n                ...state,\n                currentPage: state.currentPage !== null && state.currentCursor !== state.endCursor ?\n                    Math.max(1, (state.currentPage || 1) + 1 + (action.skipPages || 0)) : null,\n                hasPreviousPage: true,\n                hasNextPage: false,\n                skip: (action.skipPages || 0) * (state.pageSize || 25),\n                currentCursor: state.endCursor,\n                reverse: false,\n            }\n        case 'PREVIOUS_PAGE':\n            return {\n                ...state,\n                currentPage: state.currentPage !== null && state.currentCursor !== state.startCursor ?\n                    Math.max(1, (state.currentPage || 1) - 1 - (action.skipPages || 0)) : null,\n                hasNextPage: true,\n                hasPreviousPage: false,\n                skip: (action.skipPages || 0) * (state.pageSize || 25),\n                currentCursor: state.startCursor,\n                reverse: true,\n            }\n        case 'LAST_PAGE':\n            return {\n                ...state,\n                currentPage: null,\n                hasPreviousPage: true,\n                hasNextPage: false,\n                currentCursor: '',\n                skip: 0,\n                reverse: true,\n            }\n        case 'FIRST_PAGE':\n            return {\n                ...state,\n                currentPage: 1,\n                hasNextPage: true,\n                hasPreviousPage: false,\n                currentCursor: '',\n                skip: 0,\n                reverse: false,\n            }\n        default:\n            return state;\n    }\n}\n")),(0,r.kt)("p",null,"Also an example of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ardsh/slonik-trpc/blob/main/examples/datagrid-example/src/utils/CursorPagination.tsx"},"the CursorPagination component can be found on github")))}c.isMDXComponent=!0}}]);